---
title: "Code for MTHM601 report"
output:
  pdf_document: default
  html_document: default
date: "2025-01-06"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Libraries

```{r}
library(tidyverse)
library(patchwork)
library(dplyr)
library(lubridate)
library(ggpubr)
library(mgcv)
library(sf)
library(tmap)
library(leaflet)

```

## Load Roadkill dataset

```{r}
roadkill_full <- read.csv("records-2024-12-03.csv")
```

## Data Wrangling

### Rename columns

Using the dplyr package, rename columns so they are more manageable.

```{r}
head(roadkill_full)

rk <- roadkill_full %>% 
  rename(
    species = Common.name,
    date = Start.date,
    day = Start.date.day,
    month = Start.date.month,
    year = Start.date.year,
    lat = Latitude..WGS84.,
    long = Longitude..WGS84.,
    country = State.Province
  )

head(rk)
```

Create dataset with only necessary columns. Using the dplyr package.

```{r}
roadkill <- rk %>% select(species, Taxon.Rank, date, day, month, year, lat, long, country, Kingdom, Phylum, Class, Order, Family, Genus)


```

### Add a season column

I am interested in seasonal variation, not just the exact date so I am going to use an if-else function to create a season column.

```{r}
get_season <- function(month) {
  if (month %in% c(12, 1, 2)) {
    return("Winter")
  } else if (month %in% c(3, 4, 5)) {
    return("Spring")
  } else if (month %in% c(6, 7, 8)) {
    return("Summer")
  } else if (month %in% c(9, 10, 11)) {
    return("Autumn")
  } else {
    return(NA)
  }
}


roadkill <- roadkill %>%
  mutate(season = sapply(month, get_season))


head(roadkill)


```

Noticed that date is coming up as NA - so I will combine the day, month and year columns to create a new date column

```{r}
roadkill <- roadkill %>%
  mutate(date = as.Date(paste(year, month, day, sep = "-"), format = "%Y-%m-%d"))

head(roadkill)


```

### Format data types

```{r}
roadkill$day <- as.integer(roadkill$day)
roadkill$month <- as.integer(roadkill$month)
roadkill$year <- as.integer(roadkill$year)
roadkill$species <- as.factor(roadkill$species)
roadkill$Taxon.Rank <-as.factor(roadkill$Taxon.Rank)
roadkill$lat <- as.numeric(roadkill$lat)
roadkill$long <- as.numeric(roadkill$long)
roadkill$country <-as.factor(roadkill$country)
roadkill$Kingdom <-as.factor(roadkill$Kingdom)
roadkill$Phylum <-as.factor(roadkill$Phylum)
roadkill$Class <-as.factor(roadkill$Class)
roadkill$Order <-as.factor(roadkill$Order)
roadkill$Family <-as.factor(roadkill$Family)
roadkill$Genus <-as.factor(roadkill$Genus)
roadkill$season <-as.factor(roadkill$season)

str(roadkill)
```

### Remove all birds and reptiles - only keep mammals

```{r}

mammal_roadkill <- roadkill %>%
  filter(grepl("mammalia", Class, ignore.case = TRUE))

head(mammal_roadkill)
str(mammal_roadkill)


```

### Remove any NAs or blanks

```{r}

mammal_roadkill <- mammal_roadkill %>%
  mutate(species = trimws(species)) %>% 
  filter(species != "", !is.na(species)) 

head(mammal_roadkill)
str(mammal_roadkill)

```

### Unique species

```{r}
unique(mammal_roadkill$species)
```

### Remove "indet.deer" and "polecat-ferret hybrid" and "rabbit and hares"

Because they are not to a species level, I opted to remove any rows that were called these things.

```{r}
mammal_roadkill <- mammal_roadkill %>%
  filter(!species %in% c("Indet. Deer", "Polecat-Ferret", "rabbits and hares"))
```

### Standardise species names

Some species were hard to identify to species level, so I decided to group them. Also grey squirrel and squirrel, I grouped as Red Squirrels are rare in most parts of the country.

```{r}

mammal_roadkill <- mammal_roadkill %>%
  mutate(species = case_when(
    species %in% c("Eastern Grey Squirrel", "Squirrel") ~ "Grey Squirrel",
    species %in% c("Brown Rat", "Rat spp.") ~ "Rats",
    species %in% c("Wood Mouse", "House Mouse", "Small Mouse", "Yellow-necked Mouse") ~ "Mice",
    species %in% c("Bat", "Pipistrelle Bat species", "Soprano Pipistrelle", "Brown Long-eared Bat", "Pipistrelle") ~ "Bats",
    species %in% c("Field Vole", "Bank Vole", "Vole") ~ "Voles",
    species %in% c("Brown Hare", "Mountain Hare", "Irish Hare") ~ "Hares",
    TRUE ~ species 
  ))


# View the updated dataset
head(mammal_roadkill)
unique(mammal_roadkill$species)

```

### Create new CSV file

Now that I have finished with the data wrangling, I will create a new CSV file.

```{r}
write.csv(mammal_roadkill, "updated_roadkill.csv", row.names = FALSE)
```

### Exploratory Data Visualisation

#### Monthly reports

```{r}
monthly_yearly_data <- mammal_roadkill %>%
  group_by(year, month) %>%
  summarise(total_roadkill = n())

monthly_yearly_data <- monthly_yearly_data %>%
  mutate(month = factor(month, levels = 1:12, labels = month.name))

print(monthly_yearly_data)


```

```{r}
p1 <- ggplot(monthly_yearly_data, aes(x = month, y = total_roadkill, group = year, color = factor(year))) +
  geom_line() +
  theme_minimal() +
  labs(
    title = "Monthly Roadkill Trends by Year",
    x = "Month",
    y = "Total Roadkill",
    color = "Year"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

p1
```

```{r}
monthly_roadkill <- mammal_roadkill %>%
  group_by(year, month) %>%
  summarise(reports = n(), .groups = "drop")

monthly_roadkill <- monthly_roadkill %>%
  mutate(date = as.Date(paste(year, month, 1, sep = "-")))


p2 <- ggplot(monthly_roadkill, aes(x = date, y = reports)) +
  geom_line(color = "black", linewidth = 0.5) +
  theme_minimal() +
  labs(
    title = "(a)",
    x= NULL,
    y = NULL  ) +
  ylim(0,2500)+
  scale_x_date(date_labels = "%Y", date_breaks = "1 year") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

p2
```

## Scale spike in 2019

Following the methods from Raymond et al. 2021, I scaled the data based on monthly proportions and then I subsampled it 10,000 times and took the mean.

```{r}
library(dplyr)

scaled_data <- mammal_roadkill %>%
  group_by(species, year, month) %>%
  summarise(monthly_total = n(), .groups = "drop") %>%  
  group_by(species, year) %>%
  mutate(
    annual_total = sum(monthly_total), 
    monthly_percentage = round((monthly_total / annual_total) * 100, 1) 
  ) %>%
  ungroup()

head(scaled_data)


```

```{r}

set.seed(222) 

adjusted_data <- scaled_data %>%
  group_by(species) %>%
  mutate(adjusted_count = case_when(
    year == 2019 & month == 7 & monthly_total > 1 ~ round(monthly_total * 2 / 3), 
    year == 2019 & month == 8 & monthly_total > 1 ~ round(monthly_total / 2),    
    TRUE ~ monthly_total 
  )) %>%
  ungroup()

#Subsampling repeated 10,000 times and taking the mean count
adjusted_data <- adjusted_data %>%
  group_by(species, year, month) %>%
  summarise(
    mean_adjusted_count = mean(replicate(10000, {
      if (year == 2019 & month == 7 && monthly_total > 1) {
        round(monthly_total * 2 / 3)
      } else if (year == 2019 & month == 8 && monthly_total > 1) {
        round(monthly_total / 2)
      } else {
        monthly_total
      }
    })),
    .groups = "drop"
  )

head(adjusted_data)


```

Plot this adjusted data

```{r}
total_adjusted_data <- adjusted_data %>%
  group_by(year, month) %>%
  summarise(total_reports = sum(mean_adjusted_count, na.rm = TRUE), .groups = "drop") %>%
  mutate(date = ymd(paste(year, month, "01", sep = "-")))


p3 <- ggplot(total_adjusted_data, aes(x = date, y = total_reports)) +
  geom_line(color = "black", linewidth = 0.5) +
  theme_minimal() +
  labs(
    title = "(b)",
    x = NULL,
    y = "Reports"
  ) +
  ylim(0,2500)+
  scale_x_date(date_labels = "%Y", date_breaks = "1 year") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
p3
```

I decided this still resulted in too big of a spike so I will remove July - September 2019 and then ttry imputing values.

### Remove July - September 2019

```{r}

mammal_roadkill_no_spike <- mammal_roadkill %>%
  filter(!(format(date, "%Y-%m") %in% c("2019-07", "2019-08", "2019-09")))

```

### Impute values for July - September 2019

I will turn it into monthly values and then add blank rows for July - September 2019 and then impute values.

```{r}

monthly_no_spike <- mammal_roadkill_no_spike %>%
  group_by(year, month) %>%
  summarise(total_roadkill = n())

monthly_no_spike <- monthly_no_spike %>%
  mutate(month = factor(month, levels = 1:12, labels = month.name))

print(monthly_no_spike)

imputed_rk <- monthly_no_spike %>%
  mutate(month = factor(month, levels = month.name)) %>%
  group_by(month) %>%  
  mutate(monthly_mean = mean(total_roadkill, na.rm = TRUE),  
         value = ifelse(is.na(total_roadkill) & year == 2019, monthly_mean, total_roadkill)) %>%  
  select(-monthly_mean)  

print(imputed_rk)
```

Change of plan, I realised this won't work for what I need as I don't just want monthly values. I am going to calculate the mean for all July's and August's and September's (excluding 2019) and from that mean, I will randomly select that amount of reports from July and August and September in 2019 and keep those, discarding the others. Because I'm not assessing anything at a species level, it doesn't matter if I lose individual species.

```{r}
july_mean <- mammal_roadkill_no_spike %>%
  filter(format(date, "%m") == "07") %>%  
  group_by(year = format(date, "%Y")) %>%  
  summarize(july_count = n()) %>%  
  summarize(mean_july_reports = mean(july_count, na.rm = TRUE)) 

print(round(july_mean))

aug_mean <- mammal_roadkill_no_spike %>%
  filter(format(date, "%m") == "08") %>%  
  group_by(year = format(date, "%Y")) %>%  
  summarize(aug_count = n()) %>%  
  summarize(mean_aug_reports = mean(aug_count, na.rm = TRUE))  

print(round(aug_mean))

sept_mean <- mammal_roadkill_no_spike %>%
  filter(format(date, "%m") == "09") %>%  
  group_by(year = format(date, "%Y")) %>%  
  summarize(sept_count = n()) %>%  
  summarize(mean_sept_reports = mean(sept_count, na.rm = TRUE))  

print(round(sept_mean))
```

### Choose rows from 2019

```{r}
set.seed(2108)
random_sample_july_2019 <- mammal_roadkill %>%
  filter(format(date, "%Y-%m") == "2019-07") %>%
  sample_n(363)

print(random_sample_july_2019)

set.seed(2108)
random_sample_aug_2019 <- mammal_roadkill %>%
  filter(format(date, "%Y-%m") == "2019-08") %>%
  sample_n(383)

print(random_sample_aug_2019)

set.seed(2108)
random_sample_sept_2019 <- mammal_roadkill %>%
  filter(format(date, "%Y-%m") == "2019-09") %>%
  sample_n(420)

print(random_sample_sept_2019)
```

### Add these into the dataset

```{r}
mammal_no_spike <- mammal_roadkill_no_spike %>%
  bind_rows(random_sample_july_2019, random_sample_aug_2019, random_sample_sept_2019) %>%
  arrange(date)


```

### Plot

```{r}
monthly <- mammal_no_spike %>%
  group_by(year, month) %>%
  summarise(reports = n(), .groups = "drop")

monthly <- monthly %>%
  mutate(date = as.Date(paste(year, month, 1, sep = "-")))


p4 <- ggplot(monthly, aes(x = date, y = reports)) +
  geom_line(color = "black", linewidth = 0.5) +
  theme_minimal() +
  labs(
    title = "(c)",
    x= NULL,
    y = NULL  ) +
  ylim(0, 2500) +
  scale_x_date(date_labels = "%Y", date_breaks = "1 year") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

p4
```

Plot all 3 options together without their x labels.

```{r}
(p2 + theme(axis.title.x = element_blank(), axis.text.x = element_blank())) /
(p3 + theme(axis.title.x = element_blank(), axis.text.x = element_blank())) /
p4
```

## Met-Office data

Rainfall and temperature data from the met office don't download to excel files, just txt URLs so I have to load these datasets in a different way.

### Load dataset - temperature

Load dataset, turn it into a table, filter to the years I am interested in and then rearrange the table so that it is 'tidy' and each row reflects one month.

```{r}
tempURL <- "https://www.metoffice.gov.uk/pub/data/weather/uk/climate/datasets/Tmean/date/UK.txt"

temp <- read.table(tempURL, header = TRUE, skip = 5, stringsAsFactors = FALSE)

filtered_temp <- temp %>%
  filter(year >= 2014 & year <= 2024)

data_long <- filtered_temp %>%
  pivot_longer(
    cols = jan:dec,  # Month columns
    names_to = "month",
    values_to = "mean_temperature"
  ) %>%
  mutate(
    month = match(month, c("jan", "feb", "mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", "dec")),  # Convert month to integer
    year = as.numeric(year)  # Ensure year is numeric
  )

```

### Load dataset - rain

And now the same for the rain dataset.

```{r}
rainURL <- "https://www.metoffice.gov.uk/pub/data/weather/uk/climate/datasets/Rainfall/date/UK.txt" 

rain <- read.table(rainURL, header = TRUE, skip = 5, stringsAsFactors = FALSE)

filtered_rain <- rain %>%
  filter(year >= 2014 & year <= 2024)

# Step 5: Reshape the data from wide to long format
long_rain <- filtered_rain %>%
  pivot_longer(
    cols = jan:dec,  # Month columns
    names_to = "month",
    values_to = "rainfall"
  ) %>%
  mutate(
    month = match(month, c("jan", "feb", "mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", "dec")),
    year = as.numeric(year)
  )
```

### Plot temperature

```{r}
ggplot(data_long, aes(x = month, y = mean_temperature, group = year, color = factor(year))) +
  geom_smooth(se = FALSE, method = "loess", size = 1) +
  geom_vline(xintercept = c(2.5, 5.5, 8.5, 11.5), linetype = "dashed", color = "black", linewidth = 0.8) +
  scale_x_continuous(
    breaks = 1:12,  # Numeric positions (1 to 12 for months)
    labels = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")  # Month names
  ) +
  labs(
    title = "Mean Temperature Over Months (2014-2024, UK)",
    x = "Month",
    y = "Mean Temperature (°C)",
    color = "Year"
  ) +
  theme_minimal()

```

#### Plot rain

```{r}
ggplot(long_rain, aes(x = month, y = rainfall, group = year, color = factor(year))) +
  geom_smooth(se = FALSE, method = "loess", size = 1) +
  geom_vline(xintercept = c(2.5, 5.5, 8.5, 11.5), linetype = "dashed", color = "black", linewidth = 0.8) +
  scale_x_continuous(
    breaks = 1:12,  # Numeric positions (1 to 12 for months)
    labels = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")  # Month names
  ) +
  labs(
    title = "Rainfall Over Months (2014-2024, UK)",
    x = "Month",
    y = "Rainfall",
    color = "Year"
  ) +
  theme_minimal()

```

## Combine roadkill and climate data

```{r}
climate_data <- long_rain %>%
  full_join(data_long, by = c("year", "month"))


roadkill_climate <- mammal_no_spike %>%
  left_join(climate_data, by = c("year", "month"))

roadkill_climate <- roadkill_climate %>%
  mutate(across(ends_with(".x"), as.numeric)) %>%   
  mutate(across(ends_with(".y"), as.numeric)) 


roadkill_with_climate <- roadkill_climate %>%
  mutate(
    seasonal_rainfall = case_when(
      season == "Winter" ~ win.x + win.y,
      season == "Spring" ~ spr.x + spr.y,
      season == "Summer" ~ sum.x + sum.y,
      season == "Autumn" ~ aut.x + aut.y,
      TRUE ~ NA_real_  # Default for unexpected cases
    )
  ) %>%
  select(-win.x, -win.y, -spr.x, -spr.y, -sum.x, -sum.y, -aut.x, -aut.y)


roadkill_counts <- roadkill_with_climate %>%
  group_by(year, month) %>%
  summarize(roadkill_count = n(), .groups = "drop")

roadkill_with_climate <- roadkill_counts %>%
  left_join(climate_data, by = c("year", "month"))


get_season <- function(month) {
  if (month %in% c(12, 1, 2)) {
    return("Winter")
  } else if (month %in% c(3, 4, 5)) {
    return("Spring")
  } else if (month %in% c(6, 7, 8)) {
    return("Summer")
  } else if (month %in% c(9, 10, 11)) {
    return("Autumn")
  } else {
    return(NA)
  }
}


roadkill_with_climate <- roadkill_with_climate %>%
  mutate(season = sapply(month, get_season))

roadkill_with_climate$season <- factor(roadkill_with_climate$season, 
                                       levels = c("Winter", "Spring", "Summer", "Autumn"))
```

## Seasonal Trends

Graph of seasonal trends

```{r}
seasonal_trends <- mammal_no_spike %>%
  group_by(season, year) %>%
  summarize(roadkill_count = n(), .groups = "drop")

ggplot(seasonal_trends, aes(x = year, y = roadkill_count, color = season)) +
  geom_line(linewidth = 1) +
  labs(
    title = "Seasonal Trends in Mammalian Roadkill",
    x = "Year",
    y = "Number of Roadkill Reports",
    color = "Season"
  ) +
  theme_minimal()

```

Analysis

```{r}

```

## Spatial Trend

I decided to make an interactive map of the roadkill reports per region in the uk.

```{r}
uk_regions <- st_read("ITL2_JAN_2025_UK_BFE.shp")


roadkill_sf <- mammal_no_spike %>%
  st_as_sf(coords = c("long", "lat"), crs = 4326)  


uk_regions <- st_transform(uk_regions, crs = 4326)


roadkill_with_regions <- st_join(roadkill_sf, uk_regions, join = st_intersects)

print(names(uk_regions))

spatial_trends <- roadkill_with_regions %>%
  group_by(ITL225NM) %>%  
  summarize(roadkill_count = n(), .groups = "drop")

spatial_trends_map <- uk_regions %>%
  mutate(NAME = as.character(ITL225NM)) %>% 
  left_join(as.data.frame(spatial_trends), by = "ITL225NM")

spatial_trends <- roadkill_with_regions %>%
  group_by(ITL225NM) %>%  
  summarize(roadkill_count = n(), .groups = "drop")


tmap_mode("view")
m1 <- tm_shape(spatial_trends_map) +
  tm_polygons("roadkill_count", 
              title = "Roadkill Reports", 
              palette = "YlOrRd", 
              border.alpha = 0.5,
              id = "ITL225NM")

m1
```

Static map to include in report

```{r}
tmap_mode("plot")

m2 <- tm_shape(spatial_trends_map) +
  tm_polygons("roadkill_count", 
              title = "Roadkill Reports", 
              palette = "YlOrRd", 
              border.alpha = 0.5,
              id = "ITL225NM") +
  tm_layout(
    legend.position = c("left", "top"),  
    legend.text.size = 0.5,                 
    legend.title.size = 0.8                 
  )

m2
```

## Role of temp and rainfall

```{r}


# Scatter plot with regression line
ggscatter(roadkill_with_climate, x = "mean_temperature", y = "roadkill_count",
          add = "reg.line", conf.int = TRUE,
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Temperature (°C)", ylab = "Roadkill Count")


ggscatter(roadkill_with_climate, x = "rainfall", y = "roadkill_count",
          add = "reg.line", conf.int = TRUE,
          cor.coef = TRUE, cor.method = "pearson",
          xlab = "Rainfall (cm)", ylab = "Roadkill Count")

# Linear regression model
model <- lm(roadkill_count ~ mean_temperature + rainfall, data = roadkill_with_climate)

# Summary of the model
summary(model)

par(mfrow = c(2, 2))
plot(model)
```

GAM

```{r}
gam_model <- gam(roadkill_count ~ rainfall + mean_temperature + season,
                 data = roadkill_with_climate,
                 family = poisson(link = "log"))  


# Summary of the model
summary(gam_model)

# Check diagnostics
par(mfrow = c(2, 2))
gam.check(gam_model)

```

```{r}
gam_model <- gam(roadkill_count ~ te(rainfall, mean_temperature) + season,
                 data = roadkill_with_climate,
                 family = poisson(link = "log"))

summary(gam_model)
```

### Identifying hotspots

```{r}
library(spatstat)
library(sf)

# Convert roadkill data to spatial points
roadkill_points <- st_as_sf(roadkill_data, coords = c("longitude", "latitude"), crs = 4326)

# Convert to spatstat ppp object
roadkill_ppp <- as.ppp(st_coordinates(roadkill_points), W = as.owin(uk_regions))

# Perform kernel density estimation
roadkill_density <- density(roadkill_ppp, sigma = 1000)

# Plot the density map
plot(roadkill_density, main = "Kernel Density of Roadkill Incidents")

library(spdep)

# Convert roadkill points to neighbors
coords <- st_coordinates(roadkill_points)
neighbors <- knearneigh(coords, k = 8)
nb <- knn2nb(neighbors)

# Compute Getis-Ord Gi* statistic
roadkill_points$roadkill_count <- 1  # Each row is one roadkill
gi_star <- localG(roadkill_points$roadkill_count, nb)

# Add hotspot scores to roadkill points
roadkill_points$hotspot_score <- as.numeric(gi_star)

# Visualize hotspots
ggplot() +
  geom_sf(data = uk_regions, fill = "white") +
  geom_point(data = roadkill_points, aes(x = longitude, y = latitude, color = hotspot_score)) +
  scale_color_viridis_c(option = "D") +
  labs(title = "Roadkill Hotspots Across the UK", color = "Hotspot Score") +
  theme_minimal()

```
